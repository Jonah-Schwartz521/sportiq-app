# File: model/scripts/backfill_nba_scores_2025_bdl.py

import pandas as pd
import requests
import os
from pathlib import Path

def main():
    output_path = Path("model/data/processed/nba/nba_games_with_scores.parquet")
    existing = None
    if output_path.exists():
        existing = pd.read_parquet(output_path)

    # --- Normalize existing parquet schema across script versions ---
    # Older versions of this project used alternate column names for the game datetime.
    # The workflow + downstream code expects a `date` column.
    if existing is None:
        existing = pd.DataFrame()

    if not existing.empty:
        if "date" not in existing.columns:
            # Try common alternatives from earlier iterations / other ingesters
            for alt in [
                "game_date",
                "start_date",
                "start_time",
                "startTime",
                "datetime",
                "scheduled",
                "commence_time",
                "tipoff_time",
                "time",
                "utc_start",
                "start_at",
            ]:
                if alt in existing.columns:
                    existing = existing.rename(columns={alt: "date"})
                    break

        # Ensure the column exists even if we couldn't find an alternate
        if "date" not in existing.columns:
            existing["date"] = pd.NaT

        existing["date"] = pd.to_datetime(existing["date"], errors="coerce")
    else:
        # Empty frame: ensure expected column exists so later logic doesn't crash
        existing["date"] = pd.to_datetime(pd.Series([], dtype="datetime64[ns]"), errors="coerce")
    # --- End normalization ---

    # ... rest of main() function continues here ...

    # Example of other existing["date"] usage moved after normalization:
    # e.g. computing max date or filtering on date column
    # max_existing_date = existing["date"].max() if not existing.empty else None

    # Fetch new data, process, etc.

    # When constructing output dataframe, ensure datetime column is named 'date'
    # For example, if new data frame uses 'game_date' or 'start_time' as datetime column:
    # new_data = new_data.rename(columns={"game_date": "date"})  # or similar

    # Combine existing and new dataframes
    # combined = pd.concat([existing, new_data], ignore_index=True)

    # Write combined dataframe to parquet
    # combined.to_parquet(output_path, index=False)

if __name__ == "__main__":
    main()
